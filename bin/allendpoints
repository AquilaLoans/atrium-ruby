#!/usr/bin/env ruby
require "atrium"

::Atrium.configure do |config|
  config.mx_client_id = "YOUR_MX_CLIENT_ID"
  config.mx_api_key = "YOUR_MX_API_KEY"
end

puts "\n************************** Create User **************************"
user = ::Atrium::User.create identifier: "unique_id", is_disabled: "", metadata: "{\"first_name\": \"Steven\"}"
puts user.guid
userGUID = user.guid

puts "\n************************** Read User **************************"
user = ::Atrium::User.read guid: userGUID
puts user.guid

puts "\n************************** Update User **************************"
user = ::Atrium::User.read guid: userGUID
user = user.update metadata: "{\"first_name\": \"Steven\", \"last_name\": \"Universe\"}"
puts user.guid

puts "\n************************** List Users **************************"
users = ::Atrium::User.list
for user in users
  puts user.guid
end

puts "\n************************** List Institutions **************************"
name = "bank"
params = {:name => name}
institutions = ::Atrium::Institution.list query_params: params
for institution in institutions
  puts institution.name
end

puts "\n************************** Read Institution **************************"
institution = ::Atrium::Institution.read institution_code: "mxbank"
puts institution.name

puts "\n************************** Read Institution Credentials ************************** "
credentials = ::Atrium::Institution.credentials "mxbank"
for credential in credentials
  puts credential.guid
end

puts "\n************************** Create Member **************************"
# Create credential JSON object
credentialOne = {}
credentialOne[:guid] = "CRD-9f61fb4c-912c-bd1e-b175-ccc7f0275cc1"
credentialOne[:value] = "test_atrium1"

# Create another credential JSON object
credentialTwo = {}
credentialTwo[:guid] = "CRD-e3d7ea81-aac7-05e9-fbdd-4b493c6e474d"
credentialTwo[:value] = "challenge1"

# Create credential array from credential JSON Objects
credentialArray = []
credentialArray.push(credentialOne)
credentialArray.push(credentialTwo)

member = ::Atrium::Member.create user_guid: userGUID, institution_code: "mxbank", credentials: credentialArray
puts member.guid
memberGUID = member.guid

puts "\n************************** Read Member **************************"
member = ::Atrium::Member.read user_guid: userGUID, member_guid: memberGUID
puts member.guid

puts "\n************************** Update Member **************************"
member = ::Atrium::Member.read user_guid: userGUID, member_guid: memberGUID

usernameCredential = {}
usernameCredential[:guid] = "CRD-9f61fb4c-912c-bd1e-b175-ccc7f0275cc1"
usernameCredential[:value] = "test_atrium"

passwordCredential = {}
passwordCredential[:guid] = "CRD-e3d7ea81-aac7-05e9-fbdd-4b493c6e474d"
passwordCredential[:value] = "challenge"

updatedCredentials = []
updatedCredentials.push(usernameCredential)
updatedCredentials.push(passwordCredential)

member = member.update({metadata: "{\"credentials_last_refreshed_at\": \"2015-10-16\"}", credentials: updatedCredentials})
puts member.guid

puts "\n************************** List Members **************************"
members = ::Atrium::Member.list user_guid: userGUID
for member in members
  puts member.guid
end

puts "\n************************** Aggregate Member **************************"
member = ::Atrium::Member.read user_guid: userGUID, member_guid: memberGUID
member = member.aggregate
puts member.guid

puts "\n************************** Read Member Status **************************"
sleep(5)
member = ::Atrium::Member.read user_guid: userGUID, member_guid: memberGUID
member = member.aggregation_status
puts member.guid

puts "\n************************** List Member MFA Challenges **************************"
member = ::Atrium::Member.read user_guid: userGUID, member_guid: memberGUID
challenges = member.challenges
for challenge in challenges
  puts challenge.guid
end
challengeGUID = challenges[0].guid

puts "\n************************** Resume Aggregation **************************"
member = ::Atrium::Member.read user_guid: userGUID, member_guid: memberGUID

credentialOne = {}
credentialOne[:guid] = challengeGUID
credentialOne[:value] = "correct"

challengeResponses = []
challengeResponses.push(credentialOne)

member = member.resume challengeResponses
puts member.status

puts "\n************************** List Member Credentials **************************"
member = ::Atrium::Member.read user_guid: userGUID, member_guid: memberGUID
credentials = member.credentials
for credential in credentials
  puts credential.guid
end

puts "\n************************** List Member Accounts **************************"
sleep(5)
member = ::Atrium::Member.read user_guid: userGUID, member_guid: memberGUID
accounts = member.accounts
for account in accounts
  puts account.guid
end
accountGUID = accounts[0].guid

puts "\n************************** List Member Transactions **************************"
member = ::Atrium::Member.read user_guid: userGUID, member_guid: memberGUID
transactions = member.transactions
for transaction in transactions
  puts transaction.guid
end

puts "\n************************** Read Account **************************"
account = ::Atrium::Account.read user_guid: userGUID, account_guid: accountGUID
puts account.guid

puts "\n************************** List Accounts for User **************************"
user_guid = userGUID
params = {:user_guid => user_guid}
accounts = ::Atrium::Account.list params
for account in accounts
  puts account.guid
end

puts "\n************************** List Account Transactions **************************"
account = ::Atrium::Account.read user_guid: userGUID, account_guid: accountGUID

user_guid = userGUID
guid = accountGUID
params = {:user_guid => user_guid, :guid => guid}

transactions = account.transactions params
for transaction in transactions
  puts transaction.guid
end
transactionGUID = transactions[0].guid

puts "\n************************** Read a Transaction **************************"
transaction = ::Atrium::Transaction.read user_guid: userGUID, transaction_guid: transactionGUID
puts transaction.guid

puts "\n************************** List Transactions **************************"
user_guid = userGUID
account_guid = accountGUID
params = {:user_guid => user_guid, :account_guid => account_guid}

transactions = ::Atrium::Transaction.list params
for transaction in transactions
  puts transaction.guid
end

puts "\n************************** Connect Widget **************************"
widget = ::Atrium::Connect.create user_guid: userGUID
puts widget.guid

puts "\n************************** Delete Member **************************"
member = ::Atrium::Member.read user_guid: userGUID, member_guid: memberGUID
response = member.delete
puts response.attributes

puts "\n************************** Delete User **************************"
user = ::Atrium::User.read guid: userGUID
response = user.delete
puts response.attributes
